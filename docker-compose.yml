services:
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:stable
    user: "0:0"                         # 避免掛載目錄/密碼檔權限問題
    restart: always
    environment:
      # === 不讀 config.ini，全部用環境變數 ===
      - CUSTOM_CONFIG=NO

      # === 帳號/密碼（由檔案讀入，避免明文） ===
      - TWS_USERID=monitordoctor        # 你的 IB 帳號
      - TWS_PASSWORD_FILE=/home/ibgateway/.secret/tws_password

      # === 你原本 config.ini 的對應鍵 ===
      - TRADING_MODE=live               # TradingMode=live
      - TIME_ZONE=Asia/Taipei           # TimeZone=Asia/Taipei
      - AUTO_RESTART_TIME= "6:00 PM"    # AutoRestartTime=6:05 PM（12小時制）
      - RELOGIN_AFTER_TWOFA_TIMEOUT=yes # ReloginAfterSecondFactorTimeout=yes
      - TWOFA_TIMEOUT_ACTION=restart    # TwoFactorTimeoutAction=restart
      - EXISTING_SESSION_DETECTED_ACTION=primary   # ExistingSessionDetectedAction=primary
      - SAVE_TWS_SETTINGS=yes           # SaveTwsSettingsAt=yes
      - MINIMIZE_MAIN_WINDOW=no         # MinimizeMainWindow=no
      - BYPASS_WARNING=yes              # BypassWarning=yes
      - LOGIN_DIALOG_DISPLAY_TIMEOUT=120  # LoginDialogDisplayTimeout=120
      - READ_ONLY_API=yes               # ReadOnlyApi=yes
      - TWS_ACCEPT_INCOMING=yes         # AcceptIncomingConnectionAction=yes

      # === IBC 指令伺服器（等同 CommandServerPort/BindAddress/ControlFrom）===
      - COMMAND_SERVER_PORT=7462
      - BIND_ADDRESS=0.0.0.0
      - CONTROL_FROM=127.0.0.1,172.20.0.1   # 允許本機與主機(bridge)IP

      # === TWS 設定路徑（放 jts.ini 與偏好） ===
      - TWS_SETTINGS_PATH=/home/ibgateway/tws_settings
      - TZ=Asia/Taipei

      - VNC_SERVER_PASSWORD="12345"

    volumes:
      - ./tws_settings:/home/ibgateway/tws_settings
      - ./jts.ini:/home/ibgateway/tws_settings/jts.ini:ro
      - ./secrets/tws_password.txt:/home/ibgateway/.secret/tws_password:ro

    ports:
      - "127.0.0.1:4001:4003"     # live API
      - "127.0.0.1:7462:7462"     # IBC 指令伺服器（只綁本機；遠端請用 SSH 隧道）
      - "0.0.0.0:5900:5900"

    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'exec 3<>/dev/tcp/127.0.0.1/4003 || exec 3<>/dev/tcp/127.0.0.1/4004'"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

